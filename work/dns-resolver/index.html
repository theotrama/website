<!DOCTYPE html><html lang="en" data-astro-cid-37fxchfa> <head><meta charset="UTF-8"><meta name="description" property="og:description" content="Recursive DNS resolver in Erlang.
"><meta name="viewport" content="width=device-width"><meta name="generator" content="Astro v5.15.4"><title>Resolving juliusbaer.com with my own DNS resolver</title><link rel="icon" type="image/svg+xml" href="/favicon.svg"><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Public+Sans:ital,wght@0,400;0,700;1,400&family=Rubik:wght@500;600&display=swap" rel="stylesheet"><script>
	// This code is inlined in the head to make dark mode instant & blocking.
	const getThemePreference = () => {
		if (typeof localStorage !== 'undefined' && localStorage.getItem('theme')) {
			return localStorage.getItem('theme');
		}
		return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
	};
	const isDark = getThemePreference() === 'dark';
	document.documentElement.classList[isDark ? 'add' : 'remove']('theme-dark');

	if (typeof localStorage !== 'undefined') {
		// Watch the document element and persist user preference when it changes.
		const observer = new MutationObserver(() => {
			const isDark = document.documentElement.classList.contains('theme-dark');
			localStorage.setItem('theme', isDark ? 'dark' : 'light');
		});
		observer.observe(document.documentElement, { attributes: true, attributeFilter: ['class'] });
	}
</script><link rel="stylesheet" href="/website/_astro/about.D6oEqY1H.css">
<style>.pill[data-astro-cid-2qeywk4b]{display:flex;padding:.5rem 1rem;gap:.5rem;color:var(--accent-text-over);border:1px solid var(--accent-regular);background-color:var(--accent-regular);border-radius:999rem;font-size:var(--text-md);line-height:1.35;white-space:nowrap}
header[data-astro-cid-qwekciqp]{padding-bottom:2.5rem;border-bottom:1px solid var(--gray-800)}.back-link[data-astro-cid-qwekciqp]{display:none}.details[data-astro-cid-qwekciqp]{display:flex;flex-direction:column;padding:.5rem;gap:1.5rem;justify-content:space-between;align-items:center}.tags[data-astro-cid-qwekciqp]{display:flex;gap:.5rem}.description[data-astro-cid-qwekciqp]{font-size:var(--text-lg);max-width:54ch}.content[data-astro-cid-qwekciqp]{max-width:65ch;margin-inline:auto}.content[data-astro-cid-qwekciqp]>*+*{margin-top:1rem}.content[data-astro-cid-qwekciqp] h1,.content[data-astro-cid-qwekciqp] h2,.content[data-astro-cid-qwekciqp] h3,.content[data-astro-cid-qwekciqp] h4,.content[data-astro-cid-qwekciqp] h5{margin:1.5rem 0}.content[data-astro-cid-qwekciqp] img{border-radius:1.5rem;box-shadow:var(--shadow-sm);background:var(--gradient-subtle);border:1px solid var(--gray-800)}.content[data-astro-cid-qwekciqp] blockquote{font-size:var(--text-lg);font-family:var(--font-brand);font-weight:600;line-height:1.1;padding-inline-start:1.5rem;border-inline-start:.25rem solid var(--accent-dark);color:var(--gray-0)}.back-link[data-astro-cid-qwekciqp],.content[data-astro-cid-qwekciqp] a{text-decoration:1px solid underline transparent;text-underline-offset:.25em;transition:text-decoration-color var(--theme-transition)}.back-link[data-astro-cid-qwekciqp]:hover,.back-link[data-astro-cid-qwekciqp]:focus,.content[data-astro-cid-qwekciqp] a:hover,.content[data-astro-cid-qwekciqp] a:focus{text-decoration-color:currentColor}@media(min-width:50em){.back-link[data-astro-cid-qwekciqp]{display:block;align-self:flex-start}.details[data-astro-cid-qwekciqp]{flex-direction:row;gap:2.5rem}.content[data-astro-cid-qwekciqp] blockquote{font-size:var(--text-2xl)}}
</style></head> <body data-astro-cid-37fxchfa> <div class="stack backgrounds" data-astro-cid-37fxchfa> <nav data-astro-cid-dmqpwcec> <div class="menu-header" data-astro-cid-dmqpwcec> <a href="/" class="site-title" data-astro-cid-dmqpwcec> <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 256 256" aria-hidden="true" stroke="url(#icon-gradient-7wc5tade)" fill="url(#icon-gradient-7wc5tade)" style="--size:1.6em" class="astro-patnjmll" data-astro-cid-patnjmll> <g data-astro-cid-patnjmll><path fill="none" stroke-linecap="round" stroke-linejoin="round" stroke-width="16" d="m80 96 40 32-40 32m56 0h40"/><rect width="192" height="160" x="32" y="48" fill="none" stroke-linecap="round" stroke-linejoin="round" stroke-width="16.97" rx="8.5"/></g> <linearGradient id="icon-gradient-7wc5tade" x1="23" x2="235" y1="43" y2="202" gradientUnits="userSpaceOnUse" data-astro-cid-patnjmll> <stop stop-color="var(--gradient-stop-1)" data-astro-cid-patnjmll></stop> <stop offset=".5" stop-color="var(--gradient-stop-2)" data-astro-cid-patnjmll></stop> <stop offset="1" stop-color="var(--gradient-stop-3)" data-astro-cid-patnjmll></stop> </linearGradient> </svg> 
Jan Koch
</a> <menu-button data-astro-cid-dmqpwcec="true"> <template data-astro-cid-dmqpwcec> <button class="menu-button" aria-expanded="false" data-astro-cid-dmqpwcec> <span class="sr-only" data-astro-cid-dmqpwcec>Menu</span> <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 256 256" aria-hidden="true" stroke="currentcolor" fill="currentcolor" class="astro-patnjmll" data-astro-cid-patnjmll> <g data-astro-cid-patnjmll><path stroke-linecap="round" stroke-linejoin="round" stroke-width="16" d="M40 128h176M40 64h176M40 192h176"/></g>  </svg>  </button> </template> </menu-button> </div> <noscript> <ul class="nav-items" data-astro-cid-dmqpwcec> <li data-astro-cid-dmqpwcec> <a class="link" href="/" data-astro-cid-dmqpwcec> Home </a> </li><li data-astro-cid-dmqpwcec> <a aria-current="page" class="link" href="/work/" data-astro-cid-dmqpwcec> Projects </a> </li><li data-astro-cid-dmqpwcec> <a class="link" href="/about/" data-astro-cid-dmqpwcec> About </a> </li> </ul> </noscript> <noscript> <div class="menu-footer" data-astro-cid-dmqpwcec> <div class="socials" data-astro-cid-dmqpwcec> <a href="https://github.com/theotrama" class="social" data-astro-cid-dmqpwcec> <span class="sr-only" data-astro-cid-dmqpwcec>GitHub</span> <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 256 256" aria-hidden="true" stroke="currentcolor" fill="currentcolor" class="astro-patnjmll" data-astro-cid-patnjmll> <g data-astro-cid-patnjmll><g stroke-linecap="round" stroke-linejoin="round"><path fill="none" stroke-width="14.7" d="M55.7 167.2c13.9 1 21.3 13.1 22.2 14.6 4.2 7.2 10.4 9.6 18.3 7.1l1.1-3.4a60.3 60.3 0 0 1-25.8-11.9c-12-10.1-18-25.6-18-46.3"/><path fill="none" stroke-width="16" d="M61.4 205.1a24.5 24.5 0 0 1-3-6.1c-3.2-7.9-7.1-10.6-7.8-11.1l-1-.6c-2.4-1.6-9.5-6.5-7.2-13.9 1.4-4.5 6-7.2 12.3-7.2h.8c4 .3 7.6 1.5 10.7 3.2-9.1-10.1-13.6-24.3-13.6-42.3 0-11.3 3.5-21.7 10.1-30.4A46.7 46.7 0 0 1 65 67.3a8.3 8.3 0 0 1 5-4.7c2.8-.9 13.3-2.7 33.2 9.9a105 105 0 0 1 50.5 0c19.9-12.6 30.4-10.8 33.2-9.9 2.3.7 4.1 2.4 5 4.7 5 12.7 4 23.2 2.6 29.4 6.7 8.7 10 18.9 10 30.4 0 42.6-25.8 54.7-43.6 58.7 1.4 4.1 2.2 8.8 2.2 13.7l-.1 23.4v2.3"/><path fill="none" stroke-width="16" d="M160.9 185.7c1.4 4.1 2.2 8.8 2.2 13.7l-.1 23.4v2.3A98.6 98.6 0 1 0 61.4 205c-1.4-2.1-11.3-17.5-11.8-17.8-2.4-1.6-9.5-6.5-7.2-13.9 1.4-4.5 6-7.2 12.3-7.2h.8c4 .3 7.6 1.5 10.7 3.2-9.1-10.1-13.6-24.3-13.6-42.3 0-11.3 3.5-21.7 10.1-30.4A46.4 46.4 0 0 1 65 67.3a8.3 8.3 0 0 1 5-4.7c2.8-.9 13.3-2.7 33.2 9.9a105 105 0 0 1 50.5 0c19.9-12.6 30.4-10.8 33.2-9.9 2.3.7 4.1 2.4 5 4.7 5 12.7 4 23.2 2.6 29.4 6.7 8.7 10 18.9 10 30.4.1 42.6-25.8 54.7-43.6 58.6z"/><path fill="none" stroke-width="18.7" d="m170.1 203.3 17.3-12 17.2-18.7 9.5-26.6v-27.9l-9.5-27.5" /><path fill="none" stroke-width="22.7" d="m92.1 57.3 23.3-4.6 18.7-1.4 29.3 5.4m-110 32.6-8 16-4 21.4.6 20.3 3.4 13" /><path fill="none" stroke-width="13.3" d="M28.8 133a100 100 0 0 0 66.9 94.4v-8.7c-22.4 1.8-33-11.5-35.6-19.8-3.4-8.6-7.8-11.4-8.5-11.8"/></g></g>  </svg>  </a> </div> </div> </noscript> <div id="menu-content" hidden data-astro-cid-dmqpwcec> <ul class="nav-items" data-astro-cid-dmqpwcec> <li data-astro-cid-dmqpwcec> <a class="link" href="/" data-astro-cid-dmqpwcec> Home </a> </li><li data-astro-cid-dmqpwcec> <a aria-current="page" class="link" href="/work/" data-astro-cid-dmqpwcec> Projects </a> </li><li data-astro-cid-dmqpwcec> <a class="link" href="/about/" data-astro-cid-dmqpwcec> About </a> </li> </ul> <div class="menu-footer" data-astro-cid-dmqpwcec> <div class="socials" data-astro-cid-dmqpwcec> <a href="https://github.com/theotrama" class="social" data-astro-cid-dmqpwcec> <span class="sr-only" data-astro-cid-dmqpwcec>GitHub</span> <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 256 256" aria-hidden="true" stroke="currentcolor" fill="currentcolor" class="astro-patnjmll" data-astro-cid-patnjmll> <g data-astro-cid-patnjmll><g stroke-linecap="round" stroke-linejoin="round"><path fill="none" stroke-width="14.7" d="M55.7 167.2c13.9 1 21.3 13.1 22.2 14.6 4.2 7.2 10.4 9.6 18.3 7.1l1.1-3.4a60.3 60.3 0 0 1-25.8-11.9c-12-10.1-18-25.6-18-46.3"/><path fill="none" stroke-width="16" d="M61.4 205.1a24.5 24.5 0 0 1-3-6.1c-3.2-7.9-7.1-10.6-7.8-11.1l-1-.6c-2.4-1.6-9.5-6.5-7.2-13.9 1.4-4.5 6-7.2 12.3-7.2h.8c4 .3 7.6 1.5 10.7 3.2-9.1-10.1-13.6-24.3-13.6-42.3 0-11.3 3.5-21.7 10.1-30.4A46.7 46.7 0 0 1 65 67.3a8.3 8.3 0 0 1 5-4.7c2.8-.9 13.3-2.7 33.2 9.9a105 105 0 0 1 50.5 0c19.9-12.6 30.4-10.8 33.2-9.9 2.3.7 4.1 2.4 5 4.7 5 12.7 4 23.2 2.6 29.4 6.7 8.7 10 18.9 10 30.4 0 42.6-25.8 54.7-43.6 58.7 1.4 4.1 2.2 8.8 2.2 13.7l-.1 23.4v2.3"/><path fill="none" stroke-width="16" d="M160.9 185.7c1.4 4.1 2.2 8.8 2.2 13.7l-.1 23.4v2.3A98.6 98.6 0 1 0 61.4 205c-1.4-2.1-11.3-17.5-11.8-17.8-2.4-1.6-9.5-6.5-7.2-13.9 1.4-4.5 6-7.2 12.3-7.2h.8c4 .3 7.6 1.5 10.7 3.2-9.1-10.1-13.6-24.3-13.6-42.3 0-11.3 3.5-21.7 10.1-30.4A46.4 46.4 0 0 1 65 67.3a8.3 8.3 0 0 1 5-4.7c2.8-.9 13.3-2.7 33.2 9.9a105 105 0 0 1 50.5 0c19.9-12.6 30.4-10.8 33.2-9.9 2.3.7 4.1 2.4 5 4.7 5 12.7 4 23.2 2.6 29.4 6.7 8.7 10 18.9 10 30.4.1 42.6-25.8 54.7-43.6 58.6z"/><path fill="none" stroke-width="18.7" d="m170.1 203.3 17.3-12 17.2-18.7 9.5-26.6v-27.9l-9.5-27.5" /><path fill="none" stroke-width="22.7" d="m92.1 57.3 23.3-4.6 18.7-1.4 29.3 5.4m-110 32.6-8 16-4 21.4.6 20.3 3.4 13" /><path fill="none" stroke-width="13.3" d="M28.8 133a100 100 0 0 0 66.9 94.4v-8.7c-22.4 1.8-33-11.5-35.6-19.8-3.4-8.6-7.8-11.4-8.5-11.8"/></g></g>  </svg>  </a> </div> <div class="theme-toggle" data-astro-cid-dmqpwcec> <theme-toggle data-astro-cid-x3pjskd3="true"> <button data-astro-cid-x3pjskd3> <span class="sr-only" data-astro-cid-x3pjskd3>Dark theme</span> <span class="icon light" data-astro-cid-x3pjskd3><svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 256 256" aria-hidden="true" stroke="currentcolor" fill="currentcolor" class="astro-patnjmll" data-astro-cid-patnjmll> <g data-astro-cid-patnjmll><circle cx="128" cy="128" r="60" fill="none" stroke-linecap="round" stroke-linejoin="round" stroke-width="16"/><path fill="none" stroke-linecap="round" stroke-linejoin="round" stroke-width="16" d="M128 36V16M63 63 49 49m-13 79H16m47 65-14 14m79 13v20m65-47 14 14m13-79h20m-47-65 14-14"/></g>  </svg> </span> <span class="icon dark" data-astro-cid-x3pjskd3><svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 256 256" aria-hidden="true" stroke="currentcolor" fill="currentcolor" class="astro-patnjmll" data-astro-cid-patnjmll> <g data-astro-cid-patnjmll><path fill="none" stroke-linecap="round" stroke-linejoin="round" stroke-width="16" d="M216 112V64m24 24h-48m-24-64v32m16-16h-32m65 113A92 92 0 0 1 103 39h0a92 92 0 1 0 114 114Z"/></g>  </svg> </span> </button> </theme-toggle>  <script type="module">class n extends HTMLElement{constructor(){super();const e=this.querySelector("button"),t=s=>{document.documentElement.classList[s?"add":"remove"]("theme-dark"),e.setAttribute("aria-pressed",String(s))};e.addEventListener("click",()=>t(!this.isDark())),t(this.isDark())}isDark(){return document.documentElement.classList.contains("theme-dark")}}customElements.define("theme-toggle",n);</script> </div> </div> </div> </nav> <script type="module">class i extends HTMLElement{constructor(){super(),this.appendChild(this.querySelector("template").content.cloneNode(!0));const n=this.querySelector("button"),t=document.getElementById("menu-content");t.hidden=!0,t.classList.add("menu-content");const d=e=>{n.setAttribute("aria-expanded",e?"true":"false"),t.hidden=!e};n.addEventListener("click",()=>d(t.hidden));const s=e=>{d(e.matches),n.hidden=e.matches},c=window.matchMedia("(min-width: 50em)");s(c),c.addEventListener("change",s)}}customElements.define("menu-button",i);</script>   <div class="stack gap-20" data-astro-cid-qwekciqp> <div class="stack gap-15" data-astro-cid-qwekciqp> <header data-astro-cid-qwekciqp> <div class="wrapper stack gap-2" data-astro-cid-qwekciqp> <a class="back-link" href="/work/" data-astro-cid-qwekciqp><svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 256 256" aria-hidden="true" stroke="currentcolor" fill="currentcolor" class="astro-patnjmll" data-astro-cid-patnjmll> <g data-astro-cid-patnjmll><path fill="none" stroke-linecap="round" stroke-linejoin="round" stroke-width="16" d="M216 128H40m72-72-72 72 72 72"/></g>  </svg>  Work</a> <div class="hero stack gap-4 start" data-astro-cid-bbe6dxrz> <div class="stack gap-2" data-astro-cid-bbe6dxrz> <h1 class="title" data-astro-cid-bbe6dxrz>Resolving juliusbaer.com with my own DNS resolver</h1>  </div>  <div class="details" data-astro-cid-qwekciqp> <div class="tags" data-astro-cid-qwekciqp> <div class="pill" data-astro-cid-2qeywk4b>Networking</div> <div class="pill" data-astro-cid-2qeywk4b>DNS</div> <div class="pill" data-astro-cid-2qeywk4b>Erlang</div>  </div> <p class="description" data-astro-cid-qwekciqp>Recursive DNS resolver in Erlang.
</p> </div>  </div>  </div> </header> <main class="wrapper" data-astro-cid-qwekciqp> <div class="stack gap-10 content" data-astro-cid-qwekciqp> <img src="/assets/stock-1.jpg" alt="Iridescent ripples of a bright blue and pink liquid" data-astro-cid-qwekciqp> <div class="content" data-astro-cid-qwekciqp> <a href="https://github.com/theotrama/dns-resolver" target="_blank" rel="noopener noreferrer">
  View on GitHub
</a>
<h2 id="introduction">Introduction</h2>
<p>A lot of time we take for granted what happens behind the scenes. Issuing an HTTP request from a browser, well we just
use axios. Running a web server let’s use Spring Boot. Installing a reverse proxy in front of our application, nginx,
traefik, whatever you like. These tools are incredibly powerful and without them we wouldn’t be able to build the
complex systems that we work with today. We are standing on the shoulders of giants. From time to time though we need to
peek behind the curtain and understand what is happening behind these abstractions. May it be a nasty production
incident that we do not
understand or applications that have high performance requirements that we need to tweak for. At this point in
time we start to dig deeper and unravel one more layer of the onion. We go down the rabbit hole. Today I want to dig
deeper and look into a protocol that is empowering the internet. The domain name system, short DNS.</p>
<h2 id="the-protocol">The protocol</h2>
<p>The domain name
system was invented to make the internet more user-friendly. With TCP/IP you of course could use IP addresses to connect
to a server but who can remember that for example juliusbaer.com has the IP of 188.92.48.169? Here DNS comes into play
as it allows us to resolve a server name to an IP address. The domain name system is a hierarchical system where at the
top
you can find 13 logical root DNS servers <a href="https://www.iana.org/domains/root/servers">https://www.iana.org/domains/root/servers</a>. If you now want to resolve
juliusbaer.com to
an IP address you can go to any of the 13 DNS root servers and ask: “Hey do you know the IP address of juliusbaer.com?”.
Probably it will not know the address immediately, but it might know which other name server could know about it. It
thus returns a list of name servers that might know more about juliusbaer.com. So the search goes on. We ask the next
name server if it knows the IP address of juliusbaer.com. Again it
doesn’t know, but it knows who might. We continue our query until we get a list of answer records and with that we
finally have resolved juliusbaer.com to 188.92.48.169.</p>
<p>Now, this might seem simple but let’s dive one level deeper and look into the protocol which you can find
here <a href="https://datatracker.ietf.org/doc/html/rfc1035">https://datatracker.ietf.org/doc/html/rfc1035</a>. How can we query one
of those root servers for a domain name and how will it answer? Each DNS request and response consists of the following
parts: Header, Question, Answer, Authority, Additional. The header section is the only field with a fixed length. The
remaining sections can grow dynamically. When we send a DNS request we send only the header and the query section. When
we receive a DNS response it can happen that we get for example a header, a query section (repeating the query we
issued), an authority section, and an additional section. But now let’s have a look at the full protocol definition
which
you can see in the figure below.</p>
<figure id="figure-1">
  <img src="../../../public/assets/diagrams/dns-resolver/protocol.svg" alt="DNS protocol">
  <figcaption>Figure 1: The DNS protocol</figcaption>
</figure>
<p>So the first query for juliusbaer.com to one of the root DNS servers would look like this.</p>
<figure>
  <img src="../../../public/assets/diagrams/dns-resolver/juliusbaer_dns_request.svg" alt="DNS protocol">
  <figcaption>Figure 2: A DNS request for juliusbaer.com</figcaption>
</figure>
<p>For that we would get the following response which includes authority and additional records. In the authority records
we get back the authoritative name server for the
juliusbaer.com domain and in the additional record we get the IP address of this name server.</p>
<figure>
  <img src="../../../public/assets/diagrams/dns-resolver/juliusbaer_dns_response.svg" alt="DNS protocol">
  <figcaption>Figure 3: A DNS response for juliusbaer.com</figcaption>
</figure>
<h1 id="the-process">The process</h1>
<p>Now, with the basics of the protocol in our minds let us go through the process of resolving the IP of juliusbaer.com.
We create a DNS request by setting up the header and one question section where we ask for juliusbaer.com.
As we do know only the IP addresses of the
root servers
we ask l.root-servers.net: “Hey do you know something about juliusbaer.com?”. The server will
answer: “No I don’t, but I know who might know.” This basically results in the following chat</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>Us: "Hey l.root-servers.net do you know the IP of juliusbaer.com?"</span></span>
<span class="line"><span>l.root-servers.net: "No I don't but why don't you ask a.gtld-servers.net which you can find at 192.5.6.30"</span></span>
<span class="line"><span></span></span>
<span class="line"><span>Us: "Hey a.gtld-servers.net do you know the IP of juliusbaer.com?"</span></span>
<span class="line"><span>a.gtld-servers.net: "No I don't but why don't you ask a11-67.akam.net. I don't know his IP address though. But I know that a.gtld-servers.net might know. You can reach him at 192.5.630."</span></span>
<span class="line"><span></span></span>
<span class="line"><span>Us: "Damnit another name we need to resolve. Hey a.gtld-servers.net do you know the IP of a11-67.akam.net?"</span></span>
<span class="line"><span>a.gtld-servers.net: "Yes, it is 84.53.139.67."</span></span>
<span class="line"><span></span></span>
<span class="line"><span>Us: "Hey a11-67.akam.net do you know the IP of juliusbaer.com?"</span></span>
<span class="line"><span>a11-67.akam.net: "Yes, it is 188.92.48.169." </span></span></code></pre>
<p>And with that we have successfully resolved juliusbaer.com to 188.92.48.169. Simple no? If you want to double-check that
this is
correct run <code>nslookup juliusbaer.com</code> in your favorite terminal. For the full process of the resolution see also the
diagram below. Here you can see the full process in detail.</p>
<figure>
  <img src="../../../public/assets/diagrams/dns-resolver/dns_process.svg" alt="DNS resolution process">
  <figcaption>Figure 4: The process of DNS resolution for juliusbaer.com</figcaption>
</figure>
<h1 id="bringing-it-to-life">Bringing it to life</h1>
<p>As we developers love to play around with languages and tools, why not transform the above chat into code that we can
reuse for all domain names? After all this is a great learning experience especially if we pair it with trying out a new
language.
For implementing protocols the only language of choice can of course only be… Erlang. Not only because it has its own
introduction movie on YouTube <a href="https://www.youtube.com/watch?v=xrIjfIjssLE&#x26;t=6s">Erlang: The Movie</a>
but also because it supports binary pattern matching which makes it the ideal language for implementing binary
protocols. Greatly simplified our DNS resolver will have
the following structure:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>recursivelyResolve:</span></span>
<span class="line"><span>* build the DNS request</span></span>
<span class="line"><span>* send the data out over the wire</span></span>
<span class="line"><span>* consume the response</span></span>
<span class="line"><span>* Is it a response for our query? </span></span>
<span class="line"><span>  * Yes -> return the IP address</span></span>
<span class="line"><span>  * No -> call recursivelyResolve again</span></span></code></pre>
<p>Now let’s translate this pseudocode into working Erlang code. First we have our entry resolve function that we call
recursively.
Here we build the DNS request, then send it out over the wire and then parse the incoming DNS response. Based on
the DNS response we continue. If the DNS response is an authoritative answer (header field AA=1), case 1, we can
immediately end
our search because we have found a result. If that is not the case and there are no additional records, we have run into
case 2. We just get back the name server who might know about juliusbaer.com
but not its IP address. So we need to do one more level of recursion. We now call the resolve method again to resolve
the name server. Once we have done this we can continue resolving juliusbaer.com with the obtained IP. In case 3 we get
additional
records for the name server that we can ask for juliusbaer.com in the additional resources section. We can immediately
then use that
IP to ask for juliusbaer.com.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="erlang"><code><span class="line"><span style="color:#B392F0">resolve</span><span style="color:#E1E4E8">(Domain, DnsServer) </span><span style="color:#F97583">-></span></span>
<span class="line"><span style="color:#E1E4E8">  {</span><span style="color:#79B8FF">ok</span><span style="color:#E1E4E8">, DnsRequest} </span><span style="color:#F97583">=</span><span style="color:#B392F0"> build_dns_request</span><span style="color:#E1E4E8">(Domain),</span></span>
<span class="line"><span style="color:#E1E4E8">  {</span><span style="color:#79B8FF">ok</span><span style="color:#E1E4E8">, DnsResponseUnparsed} </span><span style="color:#F97583">=</span><span style="color:#B392F0"> send_dns_request</span><span style="color:#E1E4E8">(DnsRequest, DnsServer, </span><span style="color:#79B8FF">53</span><span style="color:#E1E4E8">),</span></span>
<span class="line"><span style="color:#E1E4E8">  {</span><span style="color:#79B8FF">ok</span><span style="color:#E1E4E8">, DnsResponse} </span><span style="color:#F97583">=</span><span style="color:#B392F0"> parse_dns_response</span><span style="color:#E1E4E8">(DnsResponseUnparsed),</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">  %% Case 1: Authoritative answer</span></span>
<span class="line"><span style="color:#F97583">  if</span><span style="color:#E1E4E8"> DnsResponse</span><span style="color:#F97583">#</span><span style="color:#B392F0">dns_response</span><span style="color:#E1E4E8">.answer_type </span><span style="color:#F97583">==</span><span style="color:#79B8FF"> 1</span><span style="color:#E1E4E8"> -></span></span>
<span class="line"><span style="color:#B392F0">    io</span><span style="color:#E1E4E8">:</span><span style="color:#B392F0">fwrite</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"</span><span style="color:#79B8FF">~n</span><span style="color:#9ECBFF">Answer found: </span><span style="color:#79B8FF">~p~n</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">, [DnsResponse</span><span style="color:#F97583">#</span><span style="color:#B392F0">dns_response</span><span style="color:#E1E4E8">.answer_records]),</span></span>
<span class="line"><span style="color:#E1E4E8">    {</span><span style="color:#79B8FF">ok</span><span style="color:#E1E4E8">, DnsResponse</span><span style="color:#F97583">#</span><span style="color:#B392F0">dns_response</span><span style="color:#E1E4E8">.answer_records};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">  %% Case 2: No authoritative answer and no additional resources</span></span>
<span class="line"><span style="color:#B392F0">    length</span><span style="color:#E1E4E8">(DnsResponse</span><span style="color:#F97583">#</span><span style="color:#B392F0">dns_response</span><span style="color:#E1E4E8">.additional_records) </span><span style="color:#F97583">==</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8"> -></span></span>
<span class="line"><span style="color:#E1E4E8">      {</span><span style="color:#79B8FF">ok</span><span style="color:#E1E4E8">, ParsedNameserver} </span><span style="color:#F97583">=</span><span style="color:#B392F0"> extract_name_server</span><span style="color:#E1E4E8">(DnsResponse),</span></span>
<span class="line"><span style="color:#E1E4E8">      {</span><span style="color:#79B8FF">ok</span><span style="color:#E1E4E8">, AnswerRecords} </span><span style="color:#F97583">=</span><span style="color:#B392F0"> resolve</span><span style="color:#E1E4E8">(ParsedNameserver, </span><span style="color:#9ECBFF">"199.7.83.42"</span><span style="color:#E1E4E8">),</span></span>
<span class="line"><span style="color:#E1E4E8">      FirstAnswer </span><span style="color:#F97583">=</span><span style="color:#B392F0"> hd</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">lists</span><span style="color:#E1E4E8">:</span><span style="color:#B392F0">filter</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">fun</span><span style="color:#E1E4E8">(AnswerRecord) -></span></span>
<span class="line"><span style="color:#E1E4E8">        AnswerRecord</span><span style="color:#F97583">#</span><span style="color:#B392F0">additional_record</span><span style="color:#E1E4E8">.type </span><span style="color:#F97583">==</span><span style="color:#79B8FF"> 1</span><span style="color:#F97583"> end</span><span style="color:#E1E4E8">, AnswerRecords)),</span></span>
<span class="line"><span style="color:#E1E4E8">      NewDnsServerIp </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> FirstAnswer</span><span style="color:#F97583">#</span><span style="color:#B392F0">additional_record</span><span style="color:#E1E4E8">.ip,</span></span>
<span class="line"><span style="color:#B392F0">      resolve</span><span style="color:#E1E4E8">(Domain, NewDnsServerIp);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">  %% Case 3: No authoritative answer with additional resources</span></span>
<span class="line"><span style="color:#79B8FF">    true</span><span style="color:#E1E4E8"> -></span></span>
<span class="line"><span style="color:#E1E4E8">      {</span><span style="color:#79B8FF">ok</span><span style="color:#E1E4E8">, OtherDnsServerIp} </span><span style="color:#F97583">=</span><span style="color:#B392F0"> extract_additional_resources</span><span style="color:#E1E4E8">(DnsResponse),</span></span>
<span class="line"><span style="color:#B392F0">      io</span><span style="color:#E1E4E8">:</span><span style="color:#B392F0">fwrite</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Making new call to: </span><span style="color:#79B8FF">~p~n</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">, [OtherDnsServerIp]),</span></span>
<span class="line"><span style="color:#B392F0">      resolve</span><span style="color:#E1E4E8">(Domain, OtherDnsServerIp)</span></span>
<span class="line"><span style="color:#F97583">  end</span><span style="color:#E1E4E8">.</span></span></code></pre>
<p>With that we have built our own DNS resolver for resolving A records for domain names. Cool, isn’t it? You can just take
an RfC and start coding as everything you need is so nicely described in the protocol definition. Of course, I left out
helper methods like <code>build_dns_request</code>, <code>send_dns_request</code> and others, but you can find them on
<a href="https://github.com/theotrama/dns-resolver">GitHub</a>. One more method I want to share here is the
<code>parse_header_section</code> method because it illustrates
how nice
Erlang is suited for implementing binary protocols. Remember the above definition of the DNS protocol
from <a href="#figure-1">Figure 1</a>?
With
that definition in our hands we can write a one-liner to parse the entire header. We parse the first 16 bits into the ID
variable, the next 1
bit into the QR variable (is query/response 0/1),
the next 4 bits into the Opcode and then importantly the next bit into the AA variable (remember AA=1 -> we have our
authoritative answer and can stop) and so on. And with this one line of code we already have parsed the entire header.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="erlang"><code><span class="line"><span style="color:#B392F0">parse_header_section</span><span style="color:#E1E4E8">(Response) </span><span style="color:#F97583">-></span></span>
<span class="line"><span style="color:#E1E4E8">  &#x3C;&#x3C;ID:</span><span style="color:#79B8FF">16</span><span style="color:#E1E4E8">, QR:</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">, Opcode:</span><span style="color:#79B8FF">4</span><span style="color:#E1E4E8">, AA:</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">, TC:</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">, RD:</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">, RA:</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">, Z:</span><span style="color:#79B8FF">3</span><span style="color:#E1E4E8">, RCODE:</span><span style="color:#79B8FF">4</span><span style="color:#E1E4E8">, QDCOUNT:</span><span style="color:#79B8FF">16</span><span style="color:#E1E4E8">, ANCOUNT:</span><span style="color:#79B8FF">16</span><span style="color:#E1E4E8">, NSCOUNT:</span><span style="color:#79B8FF">16</span><span style="color:#E1E4E8">, ARCOUNT:</span><span style="color:#79B8FF">16</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">_</span><span style="color:#E1E4E8">/</span><span style="color:#F97583">binary</span><span style="color:#E1E4E8">>> </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> Response,</span></span>
<span class="line"><span style="color:#E1E4E8">  {</span><span style="color:#79B8FF">ok</span><span style="color:#E1E4E8">, {ID, QR, Opcode, AA, TC, RD, RA, Z, RCODE, QDCOUNT, ANCOUNT, NSCOUNT, ARCOUNT}}.</span></span></code></pre>
<h2 id="checking-it-out">Checking it out</h2>
<p>In order to play around with the DNS you can either use <code>nslookup</code> or <code>dig</code> or you can try out a small web app I built
that
documents the process of resolving a domain. You can go to <a href="https://domain-name-resolver.fly.dev">https://domain-name-resolver.fly.dev</a> and paste
any domain
into the search field. From that you will get back the corresponding IPs and all the steps the DNS resolver took to
resolve
the domain you asked for.</p>
<h2 id="references">References</h2>
<p>If you love to try out Erlang yourself I can only highly recommend the introduction book by the language’s
founders <a href="https://erlang.org/download/erlang-book-part1.pdf">https://erlang.org/download/erlang-book-part1.pdf</a>. Other great articles on domain name resolution
are <a href="https://implement-dns.wizardzines.com/">https://implement-dns.wizardzines.com/</a> and <a href="https://timothya.com/blog/dns/">https://timothya.com/blog/dns/</a>.</p> </div> </div> </main> </div> </div>  <footer data-astro-cid-sz7xmlte> <div class="group" data-astro-cid-sz7xmlte> <p data-astro-cid-sz7xmlte>
Designed & Developed in Portland with <a href="https://astro.build/" data-astro-cid-sz7xmlte>Astro</a> <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 256 256" aria-hidden="true" stroke="currentcolor" fill="currentcolor" style="--size:1.2em" class="astro-patnjmll" data-astro-cid-patnjmll> <g data-astro-cid-patnjmll><path fill="none" stroke-linecap="round" stroke-linejoin="round" stroke-width="16" d="M94.1 184.6c-11.4 33.9-56.6 33.9-56.6 33.9s0-45.2 33.9-56.6m124.5-56.5L128 173.3 82.7 128l67.9-67.9C176.3 34.4 202 34.7 213 36.3a7.8 7.8 0 0 1 6.7 6.7c1.6 11 1.9 36.7-23.8 62.4Z"/><path fill="none" stroke-linecap="round" stroke-linejoin="round" stroke-width="16" d="M184.6 116.7v64.6a8 8 0 0 1-2.4 5.6l-32.3 32.4a8 8 0 0 1-13.5-4.1l-8.4-41.9m11.3-101.9H74.7a8 8 0 0 0-5.6 2.4l-32.4 32.3a8 8 0 0 0 4.1 13.5l41.9 8.4"/></g>  </svg>  </p> <p data-astro-cid-sz7xmlte>&copy; 2025 Jan Koch</p> </div> <p class="socials" data-astro-cid-sz7xmlte> <a href="https://github.com/theotrama" data-astro-cid-sz7xmlte> GitHub</a> </p> </footer>  </div> <script type="module">addEventListener("load",()=>document.documentElement.classList.add("loaded"));</script>  </body> </html> 