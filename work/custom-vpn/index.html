<!DOCTYPE html><html lang="en" data-astro-cid-37fxchfa> <head><meta charset="UTF-8"><meta name="description" property="og:description" content="A minimal VPN implementation in Go using TUN devices, demonstrating packet tunneling, routing, and basic UDP communication.
"><meta name="viewport" content="width=device-width"><meta name="generator" content="Astro v5.15.4"><title>Writing your own VPN implementation in Go</title><link rel="icon" type="image/svg+xml" href="/website/favicon.svg"><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Public+Sans:ital,wght@0,400;0,700;1,400&family=Rubik:wght@500;600&display=swap" rel="stylesheet"><script>
	// This code is inlined in the head to make dark mode instant & blocking.
	const getThemePreference = () => {
		if (typeof localStorage !== 'undefined' && localStorage.getItem('theme')) {
			return localStorage.getItem('theme');
		}
		return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
	};
	const isDark = getThemePreference() === 'dark';
	document.documentElement.classList[isDark ? 'add' : 'remove']('theme-dark');

	if (typeof localStorage !== 'undefined') {
		// Watch the document element and persist user preference when it changes.
		const observer = new MutationObserver(() => {
			const isDark = document.documentElement.classList.contains('theme-dark');
			localStorage.setItem('theme', isDark ? 'dark' : 'light');
		});
		observer.observe(document.documentElement, { attributes: true, attributeFilter: ['class'] });
	}
</script><link rel="stylesheet" href="/website/_astro/about.D6oEqY1H.css">
<style>.pill[data-astro-cid-2qeywk4b]{display:flex;padding:.5rem 1rem;gap:.5rem;color:var(--accent-text-over);border:1px solid var(--accent-regular);background-color:var(--accent-regular);border-radius:999rem;font-size:var(--text-md);line-height:1.35;white-space:nowrap}
header[data-astro-cid-qwekciqp]{padding-bottom:2.5rem;border-bottom:1px solid var(--gray-800)}.back-link[data-astro-cid-qwekciqp]{display:none}.details[data-astro-cid-qwekciqp]{display:flex;flex-direction:column;padding:.5rem;gap:1.5rem;justify-content:space-between;align-items:center}.tags[data-astro-cid-qwekciqp]{display:flex;gap:.5rem}.description[data-astro-cid-qwekciqp]{font-size:var(--text-lg);max-width:54ch}.content[data-astro-cid-qwekciqp]{max-width:65ch;margin-inline:auto}.content[data-astro-cid-qwekciqp]>*+*{margin-top:1rem}.content[data-astro-cid-qwekciqp] h1,.content[data-astro-cid-qwekciqp] h2,.content[data-astro-cid-qwekciqp] h3,.content[data-astro-cid-qwekciqp] h4,.content[data-astro-cid-qwekciqp] h5{margin:1.5rem 0}.content[data-astro-cid-qwekciqp] img{border-radius:1.5rem;box-shadow:var(--shadow-sm);background:var(--gradient-subtle);border:1px solid var(--gray-800)}.content[data-astro-cid-qwekciqp] blockquote{font-size:var(--text-lg);font-family:var(--font-brand);font-weight:600;line-height:1.1;padding-inline-start:1.5rem;border-inline-start:.25rem solid var(--accent-dark);color:var(--gray-0)}.back-link[data-astro-cid-qwekciqp],.content[data-astro-cid-qwekciqp] a{text-decoration:1px solid underline transparent;text-underline-offset:.25em;transition:text-decoration-color var(--theme-transition)}.back-link[data-astro-cid-qwekciqp]:hover,.back-link[data-astro-cid-qwekciqp]:focus,.content[data-astro-cid-qwekciqp] a:hover,.content[data-astro-cid-qwekciqp] a:focus{text-decoration-color:currentColor}@media(min-width:50em){.back-link[data-astro-cid-qwekciqp]{display:block;align-self:flex-start}.details[data-astro-cid-qwekciqp]{flex-direction:row;gap:2.5rem}.content[data-astro-cid-qwekciqp] blockquote{font-size:var(--text-2xl)}}
</style></head> <body data-astro-cid-37fxchfa> <div class="stack backgrounds" data-astro-cid-37fxchfa> <nav data-astro-cid-dmqpwcec> <div class="menu-header" data-astro-cid-dmqpwcec> <a href="/" class="site-title" data-astro-cid-dmqpwcec> <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 256 256" aria-hidden="true" stroke="url(#icon-gradient-20dw2drcg)" fill="url(#icon-gradient-20dw2drcg)" style="--size:1.6em" class="astro-patnjmll" data-astro-cid-patnjmll> <g data-astro-cid-patnjmll><path fill="none" stroke-linecap="round" stroke-linejoin="round" stroke-width="16" d="m80 96 40 32-40 32m56 0h40"/><rect width="192" height="160" x="32" y="48" fill="none" stroke-linecap="round" stroke-linejoin="round" stroke-width="16.97" rx="8.5"/></g> <linearGradient id="icon-gradient-20dw2drcg" x1="23" x2="235" y1="43" y2="202" gradientUnits="userSpaceOnUse" data-astro-cid-patnjmll> <stop stop-color="var(--gradient-stop-1)" data-astro-cid-patnjmll></stop> <stop offset=".5" stop-color="var(--gradient-stop-2)" data-astro-cid-patnjmll></stop> <stop offset="1" stop-color="var(--gradient-stop-3)" data-astro-cid-patnjmll></stop> </linearGradient> </svg> 
Jan Koch
</a> <menu-button data-astro-cid-dmqpwcec="true"> <template data-astro-cid-dmqpwcec> <button class="menu-button" aria-expanded="false" data-astro-cid-dmqpwcec> <span class="sr-only" data-astro-cid-dmqpwcec>Menu</span> <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 256 256" aria-hidden="true" stroke="currentcolor" fill="currentcolor" class="astro-patnjmll" data-astro-cid-patnjmll> <g data-astro-cid-patnjmll><path stroke-linecap="round" stroke-linejoin="round" stroke-width="16" d="M40 128h176M40 64h176M40 192h176"/></g>  </svg>  </button> </template> </menu-button> </div> <noscript> <ul class="nav-items" data-astro-cid-dmqpwcec> <li data-astro-cid-dmqpwcec> <a class="link" href="/website" data-astro-cid-dmqpwcec> Home </a> </li><li data-astro-cid-dmqpwcec> <a class="link" href="/website/work" data-astro-cid-dmqpwcec> Projects </a> </li><li data-astro-cid-dmqpwcec> <a class="link" href="/website/about" data-astro-cid-dmqpwcec> About </a> </li> </ul> </noscript> <noscript> <div class="menu-footer" data-astro-cid-dmqpwcec> <div class="socials" data-astro-cid-dmqpwcec> <a href="https://github.com/theotrama" class="social" data-astro-cid-dmqpwcec> <span class="sr-only" data-astro-cid-dmqpwcec>GitHub</span> <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 256 256" aria-hidden="true" stroke="currentcolor" fill="currentcolor" class="astro-patnjmll" data-astro-cid-patnjmll> <g data-astro-cid-patnjmll><g stroke-linecap="round" stroke-linejoin="round"><path fill="none" stroke-width="14.7" d="M55.7 167.2c13.9 1 21.3 13.1 22.2 14.6 4.2 7.2 10.4 9.6 18.3 7.1l1.1-3.4a60.3 60.3 0 0 1-25.8-11.9c-12-10.1-18-25.6-18-46.3"/><path fill="none" stroke-width="16" d="M61.4 205.1a24.5 24.5 0 0 1-3-6.1c-3.2-7.9-7.1-10.6-7.8-11.1l-1-.6c-2.4-1.6-9.5-6.5-7.2-13.9 1.4-4.5 6-7.2 12.3-7.2h.8c4 .3 7.6 1.5 10.7 3.2-9.1-10.1-13.6-24.3-13.6-42.3 0-11.3 3.5-21.7 10.1-30.4A46.7 46.7 0 0 1 65 67.3a8.3 8.3 0 0 1 5-4.7c2.8-.9 13.3-2.7 33.2 9.9a105 105 0 0 1 50.5 0c19.9-12.6 30.4-10.8 33.2-9.9 2.3.7 4.1 2.4 5 4.7 5 12.7 4 23.2 2.6 29.4 6.7 8.7 10 18.9 10 30.4 0 42.6-25.8 54.7-43.6 58.7 1.4 4.1 2.2 8.8 2.2 13.7l-.1 23.4v2.3"/><path fill="none" stroke-width="16" d="M160.9 185.7c1.4 4.1 2.2 8.8 2.2 13.7l-.1 23.4v2.3A98.6 98.6 0 1 0 61.4 205c-1.4-2.1-11.3-17.5-11.8-17.8-2.4-1.6-9.5-6.5-7.2-13.9 1.4-4.5 6-7.2 12.3-7.2h.8c4 .3 7.6 1.5 10.7 3.2-9.1-10.1-13.6-24.3-13.6-42.3 0-11.3 3.5-21.7 10.1-30.4A46.4 46.4 0 0 1 65 67.3a8.3 8.3 0 0 1 5-4.7c2.8-.9 13.3-2.7 33.2 9.9a105 105 0 0 1 50.5 0c19.9-12.6 30.4-10.8 33.2-9.9 2.3.7 4.1 2.4 5 4.7 5 12.7 4 23.2 2.6 29.4 6.7 8.7 10 18.9 10 30.4.1 42.6-25.8 54.7-43.6 58.6z"/><path fill="none" stroke-width="18.7" d="m170.1 203.3 17.3-12 17.2-18.7 9.5-26.6v-27.9l-9.5-27.5" /><path fill="none" stroke-width="22.7" d="m92.1 57.3 23.3-4.6 18.7-1.4 29.3 5.4m-110 32.6-8 16-4 21.4.6 20.3 3.4 13" /><path fill="none" stroke-width="13.3" d="M28.8 133a100 100 0 0 0 66.9 94.4v-8.7c-22.4 1.8-33-11.5-35.6-19.8-3.4-8.6-7.8-11.4-8.5-11.8"/></g></g>  </svg>  </a> </div> </div> </noscript> <div id="menu-content" hidden data-astro-cid-dmqpwcec> <ul class="nav-items" data-astro-cid-dmqpwcec> <li data-astro-cid-dmqpwcec> <a class="link" href="/website" data-astro-cid-dmqpwcec> Home </a> </li><li data-astro-cid-dmqpwcec> <a class="link" href="/website/work" data-astro-cid-dmqpwcec> Projects </a> </li><li data-astro-cid-dmqpwcec> <a class="link" href="/website/about" data-astro-cid-dmqpwcec> About </a> </li> </ul> <div class="menu-footer" data-astro-cid-dmqpwcec> <div class="socials" data-astro-cid-dmqpwcec> <a href="https://github.com/theotrama" class="social" data-astro-cid-dmqpwcec> <span class="sr-only" data-astro-cid-dmqpwcec>GitHub</span> <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 256 256" aria-hidden="true" stroke="currentcolor" fill="currentcolor" class="astro-patnjmll" data-astro-cid-patnjmll> <g data-astro-cid-patnjmll><g stroke-linecap="round" stroke-linejoin="round"><path fill="none" stroke-width="14.7" d="M55.7 167.2c13.9 1 21.3 13.1 22.2 14.6 4.2 7.2 10.4 9.6 18.3 7.1l1.1-3.4a60.3 60.3 0 0 1-25.8-11.9c-12-10.1-18-25.6-18-46.3"/><path fill="none" stroke-width="16" d="M61.4 205.1a24.5 24.5 0 0 1-3-6.1c-3.2-7.9-7.1-10.6-7.8-11.1l-1-.6c-2.4-1.6-9.5-6.5-7.2-13.9 1.4-4.5 6-7.2 12.3-7.2h.8c4 .3 7.6 1.5 10.7 3.2-9.1-10.1-13.6-24.3-13.6-42.3 0-11.3 3.5-21.7 10.1-30.4A46.7 46.7 0 0 1 65 67.3a8.3 8.3 0 0 1 5-4.7c2.8-.9 13.3-2.7 33.2 9.9a105 105 0 0 1 50.5 0c19.9-12.6 30.4-10.8 33.2-9.9 2.3.7 4.1 2.4 5 4.7 5 12.7 4 23.2 2.6 29.4 6.7 8.7 10 18.9 10 30.4 0 42.6-25.8 54.7-43.6 58.7 1.4 4.1 2.2 8.8 2.2 13.7l-.1 23.4v2.3"/><path fill="none" stroke-width="16" d="M160.9 185.7c1.4 4.1 2.2 8.8 2.2 13.7l-.1 23.4v2.3A98.6 98.6 0 1 0 61.4 205c-1.4-2.1-11.3-17.5-11.8-17.8-2.4-1.6-9.5-6.5-7.2-13.9 1.4-4.5 6-7.2 12.3-7.2h.8c4 .3 7.6 1.5 10.7 3.2-9.1-10.1-13.6-24.3-13.6-42.3 0-11.3 3.5-21.7 10.1-30.4A46.4 46.4 0 0 1 65 67.3a8.3 8.3 0 0 1 5-4.7c2.8-.9 13.3-2.7 33.2 9.9a105 105 0 0 1 50.5 0c19.9-12.6 30.4-10.8 33.2-9.9 2.3.7 4.1 2.4 5 4.7 5 12.7 4 23.2 2.6 29.4 6.7 8.7 10 18.9 10 30.4.1 42.6-25.8 54.7-43.6 58.6z"/><path fill="none" stroke-width="18.7" d="m170.1 203.3 17.3-12 17.2-18.7 9.5-26.6v-27.9l-9.5-27.5" /><path fill="none" stroke-width="22.7" d="m92.1 57.3 23.3-4.6 18.7-1.4 29.3 5.4m-110 32.6-8 16-4 21.4.6 20.3 3.4 13" /><path fill="none" stroke-width="13.3" d="M28.8 133a100 100 0 0 0 66.9 94.4v-8.7c-22.4 1.8-33-11.5-35.6-19.8-3.4-8.6-7.8-11.4-8.5-11.8"/></g></g>  </svg>  </a> </div> <div class="theme-toggle" data-astro-cid-dmqpwcec> <theme-toggle data-astro-cid-x3pjskd3="true"> <button data-astro-cid-x3pjskd3> <span class="sr-only" data-astro-cid-x3pjskd3>Dark theme</span> <span class="icon light" data-astro-cid-x3pjskd3><svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 256 256" aria-hidden="true" stroke="currentcolor" fill="currentcolor" class="astro-patnjmll" data-astro-cid-patnjmll> <g data-astro-cid-patnjmll><circle cx="128" cy="128" r="60" fill="none" stroke-linecap="round" stroke-linejoin="round" stroke-width="16"/><path fill="none" stroke-linecap="round" stroke-linejoin="round" stroke-width="16" d="M128 36V16M63 63 49 49m-13 79H16m47 65-14 14m79 13v20m65-47 14 14m13-79h20m-47-65 14-14"/></g>  </svg> </span> <span class="icon dark" data-astro-cid-x3pjskd3><svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 256 256" aria-hidden="true" stroke="currentcolor" fill="currentcolor" class="astro-patnjmll" data-astro-cid-patnjmll> <g data-astro-cid-patnjmll><path fill="none" stroke-linecap="round" stroke-linejoin="round" stroke-width="16" d="M216 112V64m24 24h-48m-24-64v32m16-16h-32m65 113A92 92 0 0 1 103 39h0a92 92 0 1 0 114 114Z"/></g>  </svg> </span> </button> </theme-toggle>  <script type="module">class n extends HTMLElement{constructor(){super();const e=this.querySelector("button"),t=s=>{document.documentElement.classList[s?"add":"remove"]("theme-dark"),e.setAttribute("aria-pressed",String(s))};e.addEventListener("click",()=>t(!this.isDark())),t(this.isDark())}isDark(){return document.documentElement.classList.contains("theme-dark")}}customElements.define("theme-toggle",n);</script> </div> </div> </div> </nav> <script type="module">class i extends HTMLElement{constructor(){super(),this.appendChild(this.querySelector("template").content.cloneNode(!0));const n=this.querySelector("button"),t=document.getElementById("menu-content");t.hidden=!0,t.classList.add("menu-content");const d=e=>{n.setAttribute("aria-expanded",e?"true":"false"),t.hidden=!e};n.addEventListener("click",()=>d(t.hidden));const s=e=>{d(e.matches),n.hidden=e.matches},c=window.matchMedia("(min-width: 50em)");s(c),c.addEventListener("change",s)}}customElements.define("menu-button",i);</script>   <div class="stack gap-20" data-astro-cid-qwekciqp> <div class="stack gap-15" data-astro-cid-qwekciqp> <header data-astro-cid-qwekciqp> <div class="wrapper stack gap-2" data-astro-cid-qwekciqp> <a class="back-link" href="/website/work" data-astro-cid-qwekciqp><svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 256 256" aria-hidden="true" stroke="currentcolor" fill="currentcolor" class="astro-patnjmll" data-astro-cid-patnjmll> <g data-astro-cid-patnjmll><path fill="none" stroke-linecap="round" stroke-linejoin="round" stroke-width="16" d="M216 128H40m72-72-72 72 72 72"/></g>  </svg>  Work</a> <div class="hero stack gap-4 start" data-astro-cid-bbe6dxrz> <div class="stack gap-2" data-astro-cid-bbe6dxrz> <h1 class="title" data-astro-cid-bbe6dxrz>Writing your own VPN implementation in Go</h1>  </div>  <div class="details" data-astro-cid-qwekciqp> <div class="tags" data-astro-cid-qwekciqp> <div class="pill" data-astro-cid-2qeywk4b>Low-level</div> <div class="pill" data-astro-cid-2qeywk4b>Networking</div> <div class="pill" data-astro-cid-2qeywk4b>Go</div>  </div> <p class="description" data-astro-cid-qwekciqp>A minimal VPN implementation in Go using TUN devices, demonstrating packet tunneling, routing, and basic UDP communication.
</p> </div>  </div>  </div> </header> <main class="wrapper" data-astro-cid-qwekciqp> <div class="stack gap-10 content" data-astro-cid-qwekciqp> <img src="/website/assets/stock-2.jpg" alt="A bright pink sheet of paper used to wrap flowers curves in front of rich blue background" data-astro-cid-qwekciqp> <div class="content" data-astro-cid-qwekciqp> <a href="https://github.com/theotrama/vpn" target="_blank" rel="noopener noreferrer">
  View on GitHub
</a>
<p>As a project to improve my computer networking skills and continue my Go learning journey, I decided to peek behind the
curtain of a technology that has been around for a long time: <strong>Virtual Private Networks (VPNs)</strong>.</p>
<p>These overlay networks, which provide a tunnel from server A to server B, are a great way to hide your internet traffic
from prying eyes and to ensure encryption.</p>
<p>Go is a language perfectly suited for networking development, making it an ideal candidate for this project. Before
diving into the actual implementation, however, I feel it’s necessary to explain what VPNs are and what different kinds
of protocols exist. Afterward, we’ll build our own minimal VPN implementation using only Go’s standard library plus the
<code>songgao/water</code> package for working with TUN devices.</p>
<h2 id="existing-vpn-protocols---openvpn-and-wireguard">Existing VPN protocols - OpenVPN and Wireguard</h2>
<p>Of course, the explanation above is a gross simplification and omits many important details. Let’s look one level deeper
at how different VPN protocols handle packet routing (we’ll leave encryption aside for now to keep the scope
manageable).</p>
<p>There are numerous VPN protocols, but the most popular and widely used ones are <strong>OpenVPN</strong>, <strong>IPSec</strong>, and **WireGuard
**. In this article, I’ll focus exclusively on OpenVPN and WireGuard, as they are built quite differently and help
illustrate the fundamentals of tunneling protocols.</p>
<p>The key distinction between them lies in <strong>which OSI layer they operate on</strong> and <strong>how they process packets</strong>.</p>
<ul>
<li><strong>OpenVPN</strong> supports both Layer 2 (L2) and Layer 3 (L3) tunneling.</li>
<li><strong>WireGuard</strong> is more opinionated and supports only Layer 3 tunneling.</li>
</ul>
<p>OpenVPN uses <strong>TUN/TAP devices</strong> (explained below), while WireGuard operates within the kernel itself.</p>
<h3 id="tuntap-devices">TUN/TAP Devices</h3>
<p>TUN/TAP devices are virtual networking interfaces that allow you to handle low-level networking operations in user
space, providing access to raw IP packets.</p>
<ul>
<li><strong>TUN</strong> devices operate at <strong>Layer 3 (Network Layer)</strong> — they handle IP packets.</li>
<li><strong>TAP</strong> devices operate at <strong>Layer 2 (Data Link Layer)</strong> — they handle Ethernet frames.</li>
</ul>
<p>In this article, we’ll focus only on TUN devices.</p>
<p>OpenVPN can use either TUN or TAP devices. WireGuard, on the other hand, is implemented as a kernel module and does not
use user-space TUN devices by default. Its implementation can be found here:<br>
<a href="https://github.com/torvalds/linux/tree/master/drivers/net/wireguard">https://github.com/torvalds/linux/tree/master/drivers/net/wireguard</a>.</p>
<p>When you set up a WireGuard interface, it registers a new kernel-level network device that behaves like any other (e.g.,
<code>eth0</code>, <code>lo</code>). This approach offers major performance advantages, since packets never have to leave the kernel to be
processed in user space.</p>
<p>There’s also a Go-based user-space implementation of WireGuard for non-Linux platforms:<br>
<a href="https://github.com/WireGuard/wireguard-go">https://github.com/WireGuard/wireguard-go</a>.</p>
<p>For a detailed visualization of OpenVPN’s packet flow, see this excellent diagram:<br>
<a href="https://community.openvpn.net/Pages/HowPacketsFlow">https://community.openvpn.net/Pages/HowPacketsFlow</a>.</p>
<hr>
<h2 id="packet-flow-with-tun-devices">Packet Flow with TUN Devices</h2>
<p>Since our implementation will also use TUN devices, let’s walk through an example packet flow from client to
destination, using real IPs and device names to keep it tangible.</p>
<p><strong>Client:</strong></p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>eth0: 192.168.178.20</span></span>
<span class="line"><span>default gateway: 192.168.178.1</span></span>
<span class="line"><span>TUN5: 10.0.5.1</span></span></code></pre>
<p><strong>Server:</strong></p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>Public IP: 167.71.55.250</span></span>
<span class="line"><span>TUN6: 10.0.6.1</span></span></code></pre>
<p>On the client, we first define routing rules so all outgoing packets are routed via <code>tun5</code>:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#B392F0">route</span><span style="color:#79B8FF"> -q</span><span style="color:#79B8FF"> -n</span><span style="color:#9ECBFF"> add</span><span style="color:#79B8FF"> -inet</span><span style="color:#9ECBFF"> 0.0.0.0/1</span><span style="color:#79B8FF"> -interface</span><span style="color:#9ECBFF"> utun5</span></span>
<span class="line"><span style="color:#B392F0">route</span><span style="color:#79B8FF"> -q</span><span style="color:#79B8FF"> -n</span><span style="color:#9ECBFF"> add</span><span style="color:#79B8FF"> -inet</span><span style="color:#9ECBFF"> 128.0.0.0/1</span><span style="color:#79B8FF"> -interface</span><span style="color:#9ECBFF"> utun5</span></span></code></pre>
<p>With this setup, all traffic is directed to the TUN interface. From there, in user space, we can access the raw TCP/IP
packets. We establish a UDP connection from the client to the VPN server, and for every packet received on <code>tun5</code>, we
send
it through this UDP socket to the remote server. Thus, the original packet becomes the payload of a UDP/IP packet.</p>
<p>The server listens on the same UDP socket. When it receives a packet, the OS has already processed the UDP/IP layer,
leaving us with the original IP packet, which we write to <code>tun6</code>. The kernel then routes it out through <code>eth0</code> to its
final
destination (e.g., <code>domain-name-resolver.fly.dev</code>).</p>
<p>Responses from <code>domain-name-resolver.fly.dev</code> travel back to the server, which routes packets destined for <code>10.0.5.1</code> to
the client’s tunnel interface. Here we need
to define another important routing
rule. Below script ensures that all packets coming to our server that have 10.0.5.1 as the destination address will be
sent to the tun6 interface.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#B392F0">ip</span><span style="color:#9ECBFF"> route</span><span style="color:#9ECBFF"> replace</span><span style="color:#9ECBFF"> 10.0.5.1/32</span><span style="color:#9ECBFF"> dev</span><span style="color:#9ECBFF"> utun6</span></span></code></pre>
<p>We can visualize this with logs. Suppose the client makes a request to <a href="https://domain-name-resolver.fly.dev">https://domain-name-resolver.fly.dev</a>.</p>
<p><strong>Client logs:</strong></p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>2025/10/06 11:20:05 Read from utun5: {Version:4 ... SrcAddr:10.0.5.1 DestAddr:66.241.124.31}</span></span>
<span class="line"><span>2025/10/06 11:20:05 Wrote to 167.71.35.250:8080 via UDP.</span></span></code></pre>
<p><strong>Server logs:</strong></p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>2025/10/06 09:17:03 Read from UDP: {Version:4 ... DestAddr:66.241.124.31}</span></span>
<span class="line"><span>2025/10/06 09:17:03 Wrote to utun6: {Version:4 ... DestAddr:66.241.124.31}</span></span>
<span class="line"><span>2025/10/06 09:17:03 Read from utun6: {Version:4 ... SrcAddr:66.241.124.31 DestAddr:10.0.5.1}</span></span>
<span class="line"><span>2025/10/06 09:17:03 Wrote back to client socket via UDP.</span></span></code></pre>
<p>On the way back, the client reads the UDP data, writes it to tun5, and the kernel routes it back to the original TCP
socket connection — completing the round trip.</p>
<figure id="figure-2">
  <img src="../../assets/diagrams/custom-vpn/tunnel.svg" alt="Detailed flow">
  <figcaption>Figure 2: Detailed flow of a packet in a VPN tunnel with TUN devices</figcaption>
</figure>
<hr>
<h2 id="translating-the-theory-into-code">Translating the theory into code</h2>
<p>Go is an excellent language for networking — it strikes a great balance between simplicity and low-level control. The
client and server code are nearly identical; for brevity, we’ll look only at the client.</p>
<p><strong>Create the TUN interface:</strong></p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#F97583">package</span><span style="color:#B392F0"> main</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> main</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#E1E4E8">	tun </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> utils.</span><span style="color:#B392F0">CreateTUN</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"10.0.5.1"</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">"10.0.5.2"</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">"utun5"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">	log.</span><span style="color:#B392F0">Println</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Interface Name:"</span><span style="color:#E1E4E8">, tun.</span><span style="color:#B392F0">Name</span><span style="color:#E1E4E8">())</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">	socketClient</span><span style="color:#E1E4E8">(tun)</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p><strong>Set up the UDP socket and manage packet flow:</strong></p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#F97583">package</span><span style="color:#B392F0"> main</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> socketClient</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">incomingTun</span><span style="color:#F97583"> *</span><span style="color:#B392F0">water</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Interface</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">	conn, err </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> net.</span><span style="color:#B392F0">Dial</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"udp"</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">"167.71.35.250:8080"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">	if</span><span style="color:#E1E4E8"> err </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">		log.</span><span style="color:#B392F0">Fatal</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Error opening socket."</span><span style="color:#E1E4E8">, err)</span></span>
<span class="line"><span style="color:#F97583">		return</span></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span>
<span class="line"><span style="color:#F97583">	defer</span><span style="color:#E1E4E8"> conn.</span><span style="color:#B392F0">Close</span><span style="color:#E1E4E8">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">	go</span><span style="color:#B392F0"> readFromTunToUdp</span><span style="color:#E1E4E8">(incomingTun, conn)</span></span>
<span class="line"><span style="color:#F97583">	go</span><span style="color:#B392F0"> readFromUdpToTun</span><span style="color:#E1E4E8">(incomingTun, conn)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">	select</span><span style="color:#E1E4E8"> {}</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p><strong>Forward packets from TUN → UDP:</strong></p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#F97583">package</span><span style="color:#B392F0"> main</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> readFromTunToUdp</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">tun</span><span style="color:#F97583"> *</span><span style="color:#B392F0">water</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Interface</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">conn</span><span style="color:#B392F0"> net</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Conn</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">	buf </span><span style="color:#F97583">:=</span><span style="color:#B392F0"> make</span><span style="color:#E1E4E8">([]</span><span style="color:#F97583">byte</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">65535</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">	for</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">		n, err </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> tun.</span><span style="color:#B392F0">Read</span><span style="color:#E1E4E8">(buf)</span></span>
<span class="line"><span style="color:#F97583">		if</span><span style="color:#E1E4E8"> err </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">			log.</span><span style="color:#B392F0">Printf</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Error reading from </span><span style="color:#79B8FF">%s</span><span style="color:#9ECBFF">: </span><span style="color:#79B8FF">%v\n</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">, tun.</span><span style="color:#B392F0">Name</span><span style="color:#E1E4E8">(), err)</span></span>
<span class="line"><span style="color:#F97583">			continue</span></span>
<span class="line"><span style="color:#E1E4E8">		}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">		packet </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> utils.</span><span style="color:#B392F0">ParseIPv4</span><span style="color:#E1E4E8">(buf[:n])</span></span>
<span class="line"><span style="color:#E1E4E8">		log.</span><span style="color:#B392F0">Printf</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Read from </span><span style="color:#79B8FF">%s</span><span style="color:#9ECBFF">: </span><span style="color:#79B8FF">%+v</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">, tun.</span><span style="color:#B392F0">Name</span><span style="color:#E1E4E8">(), packet)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">		if</span><span style="color:#E1E4E8"> _, err </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> conn.</span><span style="color:#B392F0">Write</span><span style="color:#E1E4E8">(buf[:n]); err </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">			log.</span><span style="color:#B392F0">Printf</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Error writing to </span><span style="color:#79B8FF">%s</span><span style="color:#9ECBFF">: </span><span style="color:#79B8FF">%v</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">, conn.</span><span style="color:#B392F0">RemoteAddr</span><span style="color:#E1E4E8">(), err)</span></span>
<span class="line"><span style="color:#F97583">			continue</span></span>
<span class="line"><span style="color:#E1E4E8">		}</span></span>
<span class="line"><span style="color:#E1E4E8">		log.</span><span style="color:#B392F0">Printf</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Wrote to </span><span style="color:#79B8FF">%s</span><span style="color:#9ECBFF"> via UDP."</span><span style="color:#E1E4E8">, conn.</span><span style="color:#B392F0">RemoteAddr</span><span style="color:#E1E4E8">())</span></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p><strong>Forward packets from UDP → TUN:</strong></p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#F97583">package</span><span style="color:#B392F0"> main</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> readFromUdpToTun</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">tun</span><span style="color:#F97583"> *</span><span style="color:#B392F0">water</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Interface</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">conn</span><span style="color:#B392F0"> net</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Conn</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">	buf </span><span style="color:#F97583">:=</span><span style="color:#B392F0"> make</span><span style="color:#E1E4E8">([]</span><span style="color:#F97583">byte</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">65535</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">	for</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">		n, err </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> conn.</span><span style="color:#B392F0">Read</span><span style="color:#E1E4E8">(buf)</span></span>
<span class="line"><span style="color:#F97583">		if</span><span style="color:#E1E4E8"> err </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">			log.</span><span style="color:#B392F0">Println</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"read error:"</span><span style="color:#E1E4E8">, err)</span></span>
<span class="line"><span style="color:#F97583">			continue</span></span>
<span class="line"><span style="color:#E1E4E8">		}</span></span>
<span class="line"><span style="color:#E1E4E8">		packet </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> utils.</span><span style="color:#B392F0">ParseIPv4</span><span style="color:#E1E4E8">(buf[:n])</span></span>
<span class="line"><span style="color:#E1E4E8">		log.</span><span style="color:#B392F0">Printf</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Will write to </span><span style="color:#79B8FF">%s</span><span style="color:#9ECBFF">: </span><span style="color:#79B8FF">%+v</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">, tun.</span><span style="color:#B392F0">Name</span><span style="color:#E1E4E8">(), packet)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">		if</span><span style="color:#E1E4E8"> _, err </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> tun.</span><span style="color:#B392F0">Write</span><span style="color:#E1E4E8">(buf[:n]); err </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">			log.</span><span style="color:#B392F0">Println</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"error writing to TUN:"</span><span style="color:#E1E4E8">, err)</span></span>
<span class="line"><span style="color:#E1E4E8">		}</span></span>
<span class="line"><span style="color:#E1E4E8">		log.</span><span style="color:#B392F0">Printf</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"</span><span style="color:#79B8FF">%s</span><span style="color:#9ECBFF">: Wrote </span><span style="color:#79B8FF">%d</span><span style="color:#9ECBFF"> bytes: </span><span style="color:#79B8FF">%+v</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">, tun.</span><span style="color:#B392F0">Name</span><span style="color:#E1E4E8">(), n, buf[:n])</span></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>With just these few functions, we have a minimal working VPN client. The server implementation mirrors this closely.</p>
<h2 id="running-the-vpn">Running the VPN</h2>
<h3 id="client">Client</h3>
<p>From the project root directory, run the following commands:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#B392F0">sudo</span><span style="color:#9ECBFF"> go</span><span style="color:#9ECBFF"> run</span><span style="color:#9ECBFF"> ./client</span><span style="color:#79B8FF"> -server</span><span style="color:#F97583"> &#x3C;</span><span style="color:#9ECBFF">SERVER_I</span><span style="color:#E1E4E8">P</span><span style="color:#F97583">></span><span style="color:#9ECBFF">:</span><span style="color:#F97583">&#x3C;</span><span style="color:#9ECBFF">SERVER_POR</span><span style="color:#E1E4E8">T</span><span style="color:#F97583">></span></span>
<span class="line"><span style="color:#79B8FF">cd</span><span style="color:#9ECBFF"> setup</span></span>
<span class="line"><span style="color:#B392F0">sudo</span><span style="color:#9ECBFF"> ./clientRouteConfig.sh</span></span></code></pre>
<h3 id="server">Server</h3>
<p>From the project root directory, run the following commands:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#B392F0">sudo</span><span style="color:#9ECBFF"> go</span><span style="color:#9ECBFF"> run</span><span style="color:#9ECBFF"> ./server</span></span>
<span class="line"><span style="color:#79B8FF">cd</span><span style="color:#9ECBFF"> setup</span></span>
<span class="line"><span style="color:#B392F0">sudo</span><span style="color:#9ECBFF"> ./serverRouteConfig.sh</span></span></code></pre>
<h2 id="next-steps">Next steps</h2>
<p>This is, of course, a very naive VPN implementation — it lacks encryption, authentication, and connection management.
The next logical step would be to add encryption, one of the core features that makes VPNs secure and private.</p>
<h1 id="useful-links">Useful Links</h1>
<ul>
<li><a href="https://www.wireguard.com/papers/wireguard.pdf">https://www.wireguard.com/papers/wireguard.pdf</a></li>
<li><a href="https://community.openvpn.net/Pages/HowPacketsFlow">https://community.openvpn.net/Pages/HowPacketsFlow</a>.</li>
</ul> </div> </div> </main> </div> </div>  <footer data-astro-cid-sz7xmlte> <div class="group" data-astro-cid-sz7xmlte> <p data-astro-cid-sz7xmlte>
Designed & Developed in Portland with <a href="https://astro.build/" data-astro-cid-sz7xmlte>Astro</a> <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 256 256" aria-hidden="true" stroke="currentcolor" fill="currentcolor" style="--size:1.2em" class="astro-patnjmll" data-astro-cid-patnjmll> <g data-astro-cid-patnjmll><path fill="none" stroke-linecap="round" stroke-linejoin="round" stroke-width="16" d="M94.1 184.6c-11.4 33.9-56.6 33.9-56.6 33.9s0-45.2 33.9-56.6m124.5-56.5L128 173.3 82.7 128l67.9-67.9C176.3 34.4 202 34.7 213 36.3a7.8 7.8 0 0 1 6.7 6.7c1.6 11 1.9 36.7-23.8 62.4Z"/><path fill="none" stroke-linecap="round" stroke-linejoin="round" stroke-width="16" d="M184.6 116.7v64.6a8 8 0 0 1-2.4 5.6l-32.3 32.4a8 8 0 0 1-13.5-4.1l-8.4-41.9m11.3-101.9H74.7a8 8 0 0 0-5.6 2.4l-32.4 32.3a8 8 0 0 0 4.1 13.5l41.9 8.4"/></g>  </svg>  </p> <p data-astro-cid-sz7xmlte>&copy; 2025 Jan Koch</p> </div> <p class="socials" data-astro-cid-sz7xmlte> <a href="https://github.com/theotrama" data-astro-cid-sz7xmlte> GitHub</a> </p> </footer>  </div> <script type="module">addEventListener("load",()=>document.documentElement.classList.add("loaded"));</script>  </body> </html> 